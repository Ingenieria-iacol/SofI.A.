<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Entalpía Hub - Ingeniería</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --blue: #002855; --cyan: #00a8e8; }
        body { background: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .nav-ent { background: var(--blue); color: white; padding: 15px; border-bottom: 5px solid var(--cyan); }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn-ent { background: var(--blue); color: white; border: none; }
        .btn-ent:hover { background: var(--cyan); }
    </style>
</head>
<body>

<div class="nav-ent text-center">
    <h2>ENTALPÍA HUB</h2>
</div>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card p-4">
                <h4>Nueva Cuenta de Cobro</h4>
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label>Deudor</label>
                        <input type="text" id="nombreDeudor" class="form-control" list="listaDeudores" oninput="completarNit(this.value)">
                        <datalist id="listaDeudores"></datalist>
                    </div>
                    <div class="col-md-6">
                        <label>NIT</label>
                        <input type="text" id="nitDeudor" class="form-control">
                    </div>
                </div>

                <div id="items" class="mt-4">
                    <div class="row g-2 mb-2 item-row">
                        <div class="col-8"><input type="text" class="form-control desc" placeholder="Concepto"></div>
                        <div class="col-4"><input type="number" class="form-control valor" placeholder="Monto"></div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="addFila()">+ Concepto</button>
                <button class="btn btn-ent w-100 mt-4 p-3" onclick="enviar()">GENERAR PDF</button>
                <div id="status" class="mt-3 text-center"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-4">
                <h4>Mis Ingresos</h4>
                <div id="audit-list" class="small">Cargando auditoría...</div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbxhLX0dyhOMUm1HT_U7SS7ApXzHV1MVeKnZKFR17fk5pRBHYBzhPwqJJKxW4QoXVygC/exec";
    let deudores = [];

    window.onload = () => {
        fetch(API).then(r => r.json()).then(d => {
            deudores = d;
            const dl = document.getElementById('listaDeudores');
            d.forEach(x => { let o = document.createElement('option'); o.value = x.nombre; dl.appendChild(o); });
        });
        cargarAuditoria();
    };

    function completarNit(v) {
        const found = deudores.find(d => d.nombre === v);
        if(found) document.getElementById('nitDeudor').value = found.nit;
    }

    function addFila() {
        const row = document.createElement('div');
        row.className = "row g-2 mb-2 item-row";
        row.innerHTML = `<div class="col-8"><input type="text" class="form-control desc"></div>
                         <div class="col-4"><input type="number" class="form-control valor"></div>`;
        document.getElementById('items').appendChild(row);
    }

    function cargarAuditoria() {
        fetch(API + "?action=auditoria").then(r => r.json()).then(data => {
            let html = '<table class="table table-sm"><tr><th>Cliente</th><th>Total</th></tr>';
            data.forEach(a => { html += `<tr><td>${a.cliente}</td><td>$${a.total.toLocaleString()}</td></tr>`; });
            document.getElementById('audit-list').innerHTML = html + '</table>';
        });
    }

    async function enviar() {
        const s = document.getElementById('status');
        s.innerText = "⏳ Generando... por favor espera.";
        
        const payload = {
            nombreDeudor: document.getElementById('nombreDeudor').value,
            nitDeudor: document.getElementById('nitDeudor').value,
            conceptos: Array.from(document.querySelectorAll('.item-row')).map(r => ({
                descripcion: r.querySelector('.desc').value,
                monto: parseFloat(r.querySelector('.valor').value) || 0
            })),
            total: Array.from(document.querySelectorAll('.valor')).reduce((a, b) => a + (parseFloat(b.value) || 0), 0)
        };

        try {
            const resp = await fetch(API, { method: 'POST', body: JSON.stringify(payload) });
            const res = await resp.json();
            if(res.url) {
                s.innerHTML = `<a href="${res.url}" target="_blank" class="btn btn-success">✅ Descargar PDF</a>`;
                cargarAuditoria();
            }
        } catch(e) { s.innerText = "Error: Asegúrate de estar logueado en Google."; }
    }
</script>
</body>
</html>
