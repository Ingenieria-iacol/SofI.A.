<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Texto a Voz Universal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 800px;
        }
        h1 { color: #333; text-align: center; }
        .controls { margin-bottom: 1rem; display: flex; gap: 10px; flex-wrap: wrap; }
        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 1rem;
        }
        button, select, input[type="file"] {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        button { background-color: #007bff; color: white; border: none; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        button.stop { background-color: #dc3545; }
        button.stop:hover { background-color: #a71d2a; }
        .file-area { background: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üó£Ô∏è Lector de Documentos</h1>

    <div class="file-area">
        <label for="fileInput"><strong>Cargar archivo (.txt, .pdf, .xlsx):</strong></label>
        <br><br>
        <input type="file" id="fileInput" accept=".txt,.pdf,.xlsx,.xls,.csv">
        <p id="status" style="color: #666; font-size: 0.9em; margin-top: 5px;"></p>
    </div>

    <textarea id="textDisplay" placeholder="Escribe aqu√≠ o carga un archivo para que sea le√≠do..."></textarea>

    <div class="controls">
        <select id="voiceSelect"><option>Cargando voces...</option></select>
        <button id="speakBtn">‚ñ∂ Reproducir</button>
        <button id="pauseBtn">‚è∏ Pausar/Reanudar</button>
        <button id="stopBtn" class="stop">‚èπ Detener</button>
    </div>
</div>

<script>
    // --- VARIABLES PRINCIPALES ---
    const synth = window.speechSynthesis;
    const textDisplay = document.getElementById('textDisplay');
    const voiceSelect = document.getElementById('voiceSelect');
    const fileInput = document.getElementById('fileInput');
    const statusMsg = document.getElementById('status');
    
    let voices = [];
    let utterance = null; // El objeto que contiene lo que se va a hablar

    // --- 1. CONFIGURACI√ìN DE VOCES ---
    function populateVoices() {
        voices = synth.getVoices();
        voiceSelect.innerHTML = '';
        
        // Filtramos para mostrar voces y preferiblemente en espa√±ol primero
        voices.forEach((voice) => {
            const option = document.createElement('option');
            option.textContent = `${voice.name} (${voice.lang})`;
            option.setAttribute('data-lang', voice.lang);
            option.setAttribute('data-name', voice.name);
            voiceSelect.appendChild(option);
            
            // Seleccionar espa√±ol por defecto si existe
            if (voice.lang.includes('es')) {
                option.selected = true;
            }
        });
    }

    populateVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoices;
    }

    // --- 2. FUNCIONES DE LECTURA (TTS) ---
    document.getElementById('speakBtn').addEventListener('click', () => {
        if (synth.speaking) {
            console.error('Ya se est√° reproduciendo audio.');
            return;
        }
        
        const text = textDisplay.value;
        if (text !== '') {
            utterance = new SpeechSynthesisUtterance(text);
            
            // Asignar la voz seleccionada
            const selectedOption = voiceSelect.selectedOptions[0].getAttribute('data-name');
            const selectedVoice = voices.find(voice => voice.name === selectedOption);
            utterance.voice = selectedVoice;

            // Eventos para controlar la UI si quisieras agregar animaciones
            utterance.onend = () => { console.log('Lectura finalizada'); };
            
            synth.speak(utterance);
        }
    });

    document.getElementById('pauseBtn').addEventListener('click', () => {
        if (synth.speaking && !synth.paused) {
            synth.pause();
        } else {
            synth.resume();
        }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        if (synth.speaking) {
            synth.cancel();
        }
    });

    // --- 3. PROCESAMIENTO DE ARCHIVOS ---
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        statusMsg.textContent = `Procesando: ${file.name}...`;
        const ext = file.name.split('.').pop().toLowerCase();

        try {
            if (ext === 'txt') {
                await readTextFile(file);
            } else if (ext === 'pdf') {
                await readPdfFile(file);
            } else if (ext === 'xlsx' || ext === 'xls' || ext === 'csv') {
                await readExcelFile(file);
            } else {
                alert('Formato no soportado por este demo b√°sico.');
            }
            statusMsg.textContent = 'Archivo cargado con √©xito.';
        } catch (error) {
            console.error(error);
            statusMsg.textContent = 'Error al leer el archivo.';
            alert('Hubo un error al intentar leer el archivo.');
        }
    });

    // Leer .txt
    function readTextFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                textDisplay.value = e.target.result;
                resolve();
            };
            reader.readAsText(file);
        });
    }

    // Leer .pdf (Usando PDF.js)
    async function readPdfFile(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';

        // Recorrer todas las p√°ginas
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n\n';
        }
        textDisplay.value = fullText;
    }

    // Leer .xlsx / .xls (Usando SheetJS)
    function readExcelFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Leemos solo la primera hoja
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convertir a texto (CSV)
                const text = XLSX.utils.sheet_to_txt(worksheet);
                textDisplay.value = text;
                resolve();
            };
            reader.readAsArrayBuffer(file);
        });
    }

    // Configurar worker de PDF.js (necesario para la librer√≠a)
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

</script>

</body>
</html>