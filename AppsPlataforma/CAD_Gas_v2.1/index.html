<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CAD Gas v14.0 - Suite Modular Final</title>
<style>
    /* ... (Mant√©n tus estilos CSS originales aqu√≠ o mu√©velos a css/styles.css) ... */
    /* Por brevedad no repito todo el CSS aqu√≠, pero ASEG√öRATE de tenerlo */
    :root { --bg: #1e1e1e; --panel: #252526; --border: #333; --accent: #0078d7; --text: #ccc; --snap: #00ffff; }
    body { font-family: 'Segoe UI', Consolas, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
    header { background-color: #2d2d2d; height: 45px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; padding: 0 15px; z-index: 100; }
    .brand { font-weight:700; color:#fff; margin-right:10px; font-size:1rem; letter-spacing:1px; }
    .brand span { color: var(--accent); }
    button.btn, select.btn, input.btn-input { background: #3c3c3c; color: #eee; border: 1px solid #555; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-size: 0.85rem; display:flex; align-items:center; gap:6px; transition:0.2s; outline:none; }
    button.btn:hover, select.btn:hover { background: #505050; border-color: #777; }
    button.primary { background: var(--accent); border-color: #005a9e; font-weight:600; }
    button.primary:hover { background: #1084e3; }
    button.danger { background: #822; border-color: #600; }
    button.btn:disabled { opacity: 0.5; cursor: default; pointer-events: none; }
    button.active, .tool-item.active { background: #444; border-color: var(--accent); color: #fff; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
    button.active { border: 1px solid var(--accent); }
    .toolbar-sep { width: 1px; height: 24px; background: #555; margin: 0 5px; }
    .layer-dropdown { position: relative; display: inline-block; }
    .layer-content { display: none; position: absolute; top: 35px; left: 0; background-color: var(--panel); min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); border: 1px solid var(--border); z-index: 200; border-radius: 4px; padding: 5px; }
    .layer-content.show { display: block; }
    .layer-row-header { display: flex; align-items: center; padding: 5px 10px; gap: 8px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; }
    .layer-row-header:hover { background: #333; }
    .layer-row-header.active { background: #37373d; border-left: 3px solid var(--accent); }
    #workspace { flex-grow: 1; display: flex; position: relative; overflow: hidden; }
    #left-panel, #right-panel { background-color: var(--panel); display: flex; flex-direction: column; z-index: 90; transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); overflow: hidden; white-space: nowrap; flex-shrink: 0; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    #left-panel { width: 260px; border-right: 1px solid var(--border); }
    #right-panel { width: 280px; border-left: 1px solid var(--border); }
    .closed { width: 0 !important; min-width: 0 !important; border: none !important; opacity: 0; pointer-events: none; }
    .panel-handle { position: absolute; top: 50%; transform: translateY(-50%); width: 20px; height: 60px; background: #2d2d2d; border: 1px solid #444; color: var(--accent); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 92; border-radius: 0 8px 8px 0; transition: 0.2s; font-size: 12px; box-shadow: 2px 0 5px rgba(0,0,0,0.3); }
    .panel-handle:hover { background: #444; width: 25px; color: #fff; }
    .handle-left { left: 0; }
    .handle-right { right: 0; border-radius: 8px 0 0 8px; border-left: 1px solid #444; border-right: none; }
    #left-panel:not(.closed) + .handle-left { left: 260px; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; margin-left: -10px; }
    #right-panel:not(.closed) ~ .handle-right { right: 280px; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; margin-right: -10px; }
    .panel-header { padding: 10px; background: #2d2d2d; font-weight:600; color:#fff; border-bottom:1px solid var(--border); display:flex; justify-content: space-between; align-items: center; }
    .lib-group { border-bottom: 1px solid var(--border); }
    .lib-group-title { padding: 8px 12px; cursor: pointer; font-size:0.8rem; font-weight:bold; color:#888; text-transform:uppercase; display:flex; justify-content:space-between; transition: 0.2s;}
    .lib-group-title:hover { color: #fff; background: #333; }
    .lib-items { display: none; padding: 5px; background: #1e1e1e; max-height: 400px; overflow-y: auto; } 
    .lib-items.open { display: block; animation: fadeIn 0.3s; }
    .lib-subheader { font-size: 0.7rem; color: var(--accent); font-weight: bold; margin: 10px 0 4px 5px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 2px; }
    .tool-item { position: relative; display: flex; align-items: center; gap: 10px; padding: 6px 10px; margin: 2px 0; cursor: pointer; border-radius: 4px; transition: 0.1s; border: 1px solid transparent; }
    .tool-item:hover { background: #383838; } 
    .tool-item.active { background: #37373d; border-color: var(--accent); box-shadow: inset 3px 0 0 var(--accent); }
    .tool-icon { width: 20px; text-align: center; font-size: 1.1rem; } .tool-name { font-size: 0.85rem; }
    .lib-tooltip { display: none; position: absolute; left: 100%; top: 0; width: 280px; background: rgba(30, 30, 30, 0.98); border: 1px solid var(--accent); padding: 12px; z-index: 1000; font-size: 0.8rem; color: #ddd; box-shadow: 4px 4px 15px rgba(0,0,0,0.7); white-space: normal; border-radius: 0 4px 4px 4px; backdrop-filter: blur(4px); pointer-events: none; }
    .tool-item:hover .lib-tooltip { display: block; }
    .tooltip-title { font-weight: bold; color: #fff; font-size: 0.9rem; margin-bottom: 4px; display:block; border-bottom: 1px solid #444; padding-bottom: 4px;}
    .tooltip-desc { margin-bottom: 6px; color: #bbb; line-height: 1.3;}
    .tooltip-meta { font-style: italic; color: #0078d7; font-size: 0.75rem; display: block; margin-top: 5px;}
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #main-area { flex-grow: 1; position: relative; background: #111; cursor: none; }
    svg { display: block; width: 100%; height: 100%; }
    #cmd-panel { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(40, 40, 40, 0.9); border: 1px solid #555; padding: 5px; border-radius: 6px; display: flex; gap: 5px; backdrop-filter: blur(5px); z-index: 95; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .cmd-divider { width: 1px; background: #555; margin: 0 5px; }
    #gizmo-container { position: absolute; bottom: 50px; left: 20px; width: 80px; height: 80px; pointer-events: none; z-index: 95; }
    .axis-line { stroke-width: 2; marker-end: url(#arrow); stroke-linecap: round; } .axis-text { font-family: monospace; font-weight: bold; font-size: 10px; }
    .grid-path, .grid-axis, .grid-minor { fill: none; pointer-events: none; }
    .grid-path { stroke: #2a2a2a; stroke-width: 1; vector-effect: non-scaling-stroke; }
    .grid-minor { stroke: #222; stroke-width: 0.5; vector-effect: non-scaling-stroke; opacity: 0.6; } 
    .grid-axis { stroke: #333; stroke-width: 2; vector-effect: non-scaling-stroke; }
    #capa-interfaz, #capa-referencias, #capa-hover { pointer-events: none; }
    .tuberia { fill: none; stroke-linecap: round; stroke-linejoin: round; shape-rendering: geometricPrecision; transition: stroke 0.1s; } 
    .fitting-auto { fill: none; stroke-linecap: round; stroke-linejoin: round; pointer-events: none; }
    .dim-line { stroke: #aaa; stroke-width: 1; vector-effect: non-scaling-stroke; pointer-events: none; }
    .dim-text { fill: #aaa; font-size: 12px; text-anchor: middle; font-family: monospace; pointer-events: none; }
    .label-tech { fill: #777; font-size: 9px; font-family: 'Segoe UI', sans-serif; pointer-events: none; text-anchor: middle; text-shadow: 1px 1px 2px #000; font-weight: 500; }
    .z-ref-line { stroke: #666; stroke-dasharray: 2,2; vector-effect: non-scaling-stroke; opacity: 0.5; }
    .cursor-crosshair { stroke: #fff; stroke-width: 1.5; vector-effect: non-scaling-stroke; opacity: 1; filter: drop-shadow(0 0 2px black); }
    .snap-marker { fill: none; stroke: var(--snap); stroke-width: 2; vector-effect: non-scaling-stroke; filter: drop-shadow(0 0 2px var(--snap)); }
    .hover-halo { stroke: #fff; stroke-width: 6; opacity: 0.3; fill: none; pointer-events: none; stroke-linecap: round; }
    .sel-halo { stroke: var(--accent); stroke-width: 4; opacity: 0.8; fill: none; pointer-events: none; stroke-linecap: round; }
    .sub-panel { display: flex; flex-direction: column; height: 100%;}
    .sp-top { flex: 1; overflow-y:auto; padding-bottom: 20px;} 
    .acc-group { border-bottom: 1px solid #333; }
    .acc-header { padding: 10px 15px; background: #2a2a2a; color: #ddd; font-weight: 600; font-size: 0.8rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; text-transform: uppercase; }
    .acc-header:hover { background: #333; color: #fff; }
    .acc-header::after { content: '‚ñº'; font-size: 0.7rem; transition: transform 0.2s; }
    .acc-group.collapsed .acc-header::after { transform: rotate(-90deg); }
    .acc-content { display: block; padding: 10px 0; background: #252526; }
    .acc-group.collapsed .acc-content { display: none; }
    .prop-row { margin: 8px 15px; display: flex; flex-direction: column; gap: 4px; }
    .prop-row.row-h { flex-direction: row; align-items: center; justify-content: space-between; gap: 10px; }
    .prop-row label { color: #aaa; font-size: 0.75rem; }
    .prop-row input[type="text"], .prop-row input[type="number"], .prop-row select { width: 100%; background: #181818; border: 1px solid #444; color: #eee; padding: 6px; border-radius: 3px; font-size: 0.85rem; box-sizing: border-box; }
    .prop-row input[type="color"] { width: 100%; height: 30px; border: 1px solid #444; background: #181818; padding: 2px; cursor: pointer; }
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: var(--accent); margin-top: -5px; cursor: pointer; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px; }
    .hud-overlay { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 4px; color: #ccc; font-family: monospace; display: flex; align-items: center; gap: 12px; backdrop-filter: blur(2px); border: 1px solid #444; }
    .hud-group { display: flex; align-items: center; gap: 5px; }
    .hud-label { font-size: 0.75rem; color: #888; font-weight: bold; }
    .hud-input { width: 45px; background: transparent; border: none; border-bottom: 1px solid #555; color: #0ff; font-family: monospace; font-size: 1em; text-align: center; outline: none; transition: 0.2s;}
    .hud-input:focus { border-bottom-color: var(--accent); background: rgba(255,255,255,0.1); width: 60px;}
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:200; justify-content:center; align-items:center; }
    .modal-box { background: var(--panel); padding:20px; border:1px solid #555; width:500px; border-radius:5px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    #dynamic-input-container, #vertical-input-container { position: absolute; background: rgba(37, 37, 38, 0.95); border: 1px solid var(--accent); padding: 5px 8px; border-radius: 4px; display: none; align-items: center; gap: 5px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    .float-input { width: 70px; background: #111; border: 1px solid #444; color: #fff; padding: 2px 5px; border-radius: 2px; outline: none; font-family: monospace; }
    .float-input:focus { border-color: var(--accent); }
    #vertical-input-container { border-color: #0f0; flex-direction: column; align-items: flex-start; padding: 10px; min-width: 150px; }
    #v-title { color: #0f0; font-weight: bold; font-size: 0.8rem; margin-bottom: 5px; display:flex; gap:5px; align-items:center;}
    #hover-tooltip { position: absolute; display: none; pointer-events: none; z-index: 2000; background: rgba(0, 0, 0, 0.85); border: 1px solid #777; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; color: #fff; font-family: monospace; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); white-space: nowrap; backdrop-filter: blur(2px); }
</style>
</head>
<body>

<header>
    <div class="brand"><span>CAD</span> GAS v14.0</div>
    <div class="toolbar-sep"></div>
    <button class="btn" id="btn-undo" onclick="undo()" title="Deshacer (Ctrl+Z)">‚Ü©</button>
    <button class="btn" id="btn-redo" onclick="redo()" title="Rehacer (Ctrl+Y)">‚Ü™</button>
    <div class="toolbar-sep"></div>
    <button class="btn" onclick="guardarProyecto()">üíæ Guardar</button>
    <button class="btn" onclick="document.getElementById('file-input').click()">üìÇ Abrir</button>
    <button class="btn danger" onclick="limpiarTodo()">üóëÔ∏è Nuevo</button>
    <input type="file" id="file-input" style="display:none" onchange="cargarProyecto(this)">
    <div class="toolbar-sep"></div>
    <button id="btn-select" class="btn active" onclick="setTool('select')">üëÜ Sel.</button>
    <button id="btn-cut" class="btn" onclick="setTool('cut')">‚úÇÔ∏è Cortar</button>
    <button id="btn-cota" class="btn" onclick="setTool('cota')">üìè Cota</button>
    <button id="btn-texto" class="btn" onclick="setTool('texto')">T Texto</button>
    <button id="btn-insert" class="btn" onclick="setTool('insert')">üìç Insertar</button>
    <div class="toolbar-sep"></div>
    <div class="layer-dropdown">
        <button class="btn" onclick="toggleLayerMenu()">üìö Capas ‚ñº</button>
        <div id="layer-menu-content" class="layer-content">
            <div id="lista-capas-header"></div>
            <div style="padding:5px; border-top:1px solid #444;">
                <button class="btn" style="width:100%" onclick="addLayer()">+ Nueva Capa</button>
            </div>
        </div>
    </div>
    <button id="btn-toggle-tags" class="btn active" onclick="toggleTags()">üè∑Ô∏è Etiquetas</button>
    <div class="toolbar-sep"></div>
    <select class="btn" onchange="setUnit(this.value)">
        <option value="m">Metros (m)</option>
        <option value="dm">cm</option> <option value="mm">mm</option>
    </select>
    <div class="toolbar-sep"></div>
    <button class="btn" onclick="mostrarReporte()">üìã Lista</button>
    <button class="btn" onclick="descargarImagen()">üì∏ Foto</button>
    <div id="msg-guardado" style="display:none; color:#0f0; font-size:0.8rem; margin-left:10px;">Guardado OK</div>
</header>

<div id="workspace">
    <div id="left-panel">
        <div class="panel-header"><span>Biblioteca</span><span style="font-size:0.8rem; cursor:pointer;" onclick="togglePanel('left-panel')">‚úï</span></div>
        <div class="lib-group"><div class="lib-group-title" onclick="toggleGroup('grp-mat')">Tuber√≠as <span>‚ñº</span></div><div class="lib-items open" id="grp-mat"></div></div>
        <div class="lib-group"><div class="lib-group-title" onclick="toggleGroup('grp-comp')">Componentes <span>‚ñº</span></div><div class="lib-items" id="grp-comp"></div></div>
        <div class="lib-group"><div class="lib-group-title" onclick="toggleGroup('grp-eq')">Equipos <span>‚ñº</span></div><div class="lib-items" id="grp-eq"></div></div>
        <div class="lib-group"><div class="lib-group-title" onclick="toggleGroup('grp-inst')">Instrumentos <span>‚ñº</span></div><div class="lib-items" id="grp-inst"></div></div>
        <div class="lib-group"><div class="lib-group-title" onclick="toggleGroup('grp-perif')">Perif√©ricos <span>‚ñº</span></div><div class="lib-items" id="grp-perif"></div></div>
        <div class="lib-group"><div class="lib-group-title" onclick="toggleGroup('grp-cons')">Consumibles <span>‚ñº</span></div><div class="lib-items" id="grp-cons"></div></div>
    </div>
    <div class="panel-handle handle-left" onclick="togglePanel('left-panel')">üõ†Ô∏è</div>
    
    <div id="main-area">
        <div id="cmd-panel">
            <button id="cmd-grid" class="btn active" onclick="toggleConfig('grid')" style="padding:4px 8px;">Grid ‚ñ¶</button>
            <button id="cmd-snap" class="btn active" onclick="toggleConfig('snap')" style="padding:4px 8px;">Snap üß≤</button>
            <div class="cmd-divider"></div>
            <button class="btn" onclick="resetView()" style="padding:4px 8px;">Centrar üéØ</button>
        </div>
        <svg id="lienzo-cad">
            <defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="#f00" /></marker></defs>
            <g id="world-transform">
                <g id="grid-layer"><path id="grid-minor" class="grid-minor"></path><path id="grid-path" class="grid-path"></path><path id="grid-axis" class="grid-axis"></path></g>
                <g id="capa-referencias"></g><g id="contenedor-elementos"></g><g id="capa-fittings"></g><g id="capa-seleccion"></g><g id="capa-hover"></g><g id="capa-interfaz"></g>
            </g>
        </svg>
        <div id="gizmo-container"><svg id="gizmo-svg" viewBox="0 0 100 100"><g id="gizmo-axes" transform="translate(50,50)"></g></svg></div>
        <div class="hud-overlay">
            <div class="hud-group"><span class="hud-label">ELEV(Z)</span><input type="number" id="hud-z-input" class="hud-input" value="0.00" step="0.10" onchange="updateZInput(this.value)"><span class="hud-label" id="hud-z-unit" style="font-size:0.6rem; font-weight:normal;">m</span></div>
            <div style="width:1px; height:15px; background:#555;"></div>
            <div class="hud-group"><span class="hud-label">ZOOM</span><input type="number" id="hud-scale-input" class="hud-input" value="100" onchange="updateZoomInput(this.value)"><span class="hud-label" style="font-weight:normal;">%</span></div>
            <div style="width:1px; height:15px; background:#555;"></div>
            <div class="hud-group"><span class="hud-label">ROT</span><input type="number" id="hud-rot-input" class="hud-input" value="45" onchange="updateRotInput(this.value)"><span class="hud-label" style="font-weight:normal;">¬∞</span></div>
        </div>
        <div id="dynamic-input-container"><span>L:</span><input type="text" id="dynamic-len" class="float-input"><span style="color:#0f0">‚úî</span></div>
        <div id="vertical-input-container"><div id="v-title"><span id="v-icon">‚¨Ü</span> <span id="v-text">SUBIENDO</span></div><div style="display:flex; align-items:center; gap:5px;"><label style="font-size:0.8rem; color:#ccc;">Longitud:</label><input type="text" id="v-len" class="float-input" placeholder="0.00"><span style="font-size:0.8rem; color:#888;">m</span></div><div style="font-size:0.7rem; color:#777; margin-top:5px;">[Enter] confirmar, [Esc] cancelar</div></div>
        <div id="hover-tooltip">Z: 0.00m</div>
    </div>
    
    <div id="right-panel" class="closed">
        <div class="panel-header"><span>Propiedades</span><span style="font-size:0.8rem; cursor:pointer;" onclick="togglePanel('right-panel')">‚úï</span></div>
        <div class="sub-panel">
            <div id="prop-vacio" style="padding:20px; color:#666; text-align:center; font-size:0.85rem;">Seleccione un objeto para ver sus propiedades</div>
            <div id="prop-form" class="sp-top" style="display:none;">
                <div class="acc-group" id="grp-general">
                    <div class="acc-header" onclick="toggleAccordion('grp-general')">Informaci√≥n</div>
                    <div class="acc-content">
                        <div class="prop-row row-h"><label style="color:#fff; font-weight:bold;">Visibilidad</label><input type="checkbox" id="p-visible" onchange="updateRootProp('visible', this.checked)" style="width:auto; cursor:pointer;"></div>
                        <div class="prop-row row-h"><label style="color:#fff;">Mostrar Etiqueta</label><input type="checkbox" id="p-show-label" onchange="updateBooleanProp('mostrarEtiqueta', this.checked)" style="width:auto; cursor:pointer;"></div>
                        <div class="prop-row"><label>Tag (Etiqueta)</label><input type="text" id="p-tag" onchange="updateStyleProp('tag', this.value)"></div>
                        <div class="prop-row"><label>Capa Actual</label><select id="p-capa" class="btn" onchange="updateStyleProp('layerId', this.value)"></select></div>
                    </div>
                </div>
                <div class="acc-group" id="grp-geo">
                    <div class="acc-header" onclick="toggleAccordion('grp-geo')">Geometr√≠a</div>
                    <div class="acc-content">
                        <div class="prop-row"><label>Elevaci√≥n Z1 (<span id="lbl-unit-z">m</span>)</label><input type="text" id="p-altura" inputmode="decimal" onchange="updateAltura(this.value)" placeholder="0.00"></div>
                        <div class="prop-row" id="row-altura-final" style="display:none;"><label>Elevaci√≥n Z2 (<span id="lbl-unit-z-final">m</span>)</label><input type="text" id="p-altura-final" inputmode="decimal" onchange="updateAlturaFinal(this.value)" placeholder="0.00"></div>
                        <div class="prop-row" id="row-longitud"><label>Longitud (<span id="lbl-unit">m</span>)</label><input type="text" inputmode="decimal" id="p-longitud" onchange="updateLongitud(this.value)"></div>
                    </div>
                </div>
                <div id="prop-datos-tecnicos-container"></div>
                <div class="acc-group" id="grp-app">
                    <div class="acc-header" onclick="toggleAccordion('grp-app')">Apariencia</div>
                    <div class="acc-content">
                        <div id="obj-adjust-controls" style="display:none;">
                            <div class="prop-row"><label>Tama√±o Visual</label><div style="display:flex; align-items:center; gap:5px;"><input type="range" id="p-scale" min="0.1" max="3" step="0.1" oninput="updateStyleProp('scaleFactor', this.value)" style="flex-grow:1;"><span id="p-scale-val" style="font-size:0.7rem; color:#888; width:25px;">1.0</span></div></div>
                            <div class="prop-row"><label>Punto de Acople</label><select id="p-anchor" class="btn" onchange="updateStyleProp('anchor', this.value)"><option value="start">Inicio</option><option value="center">Centro</option><option value="end">Fin</option></select></div>
                        </div>
                        <div class="prop-row"><label>Color</label><input type="color" id="p-color" onchange="updateStyleProp('color', this.value)"></div>
                        <div class="prop-row" id="row-tipo-linea"><label>Tipo de L√≠nea</label><select id="p-linestyle" class="btn" onchange="updateStyleProp('tipoLinea', this.value)"><option value="solid">S√≥lida (‚éØ‚éØ‚éØ)</option><option value="dashed">Guiones (- - -)</option><option value="dotted">Punteada (¬∑ ¬∑ ¬∑)</option></select></div>
                        <div class="prop-row" id="row-grosor"><label>Grosor Visual</label><input type="number" id="p-grosor" value="2" onchange="updateStyleProp('grosor', this.value)"></div>
                        <div class="prop-row"><label>Rotaci√≥n (¬∞)</label><input type="number" id="p-rot" onchange="updateStyleProp('rotacion', this.value)"></div>
                    </div>
                </div>
                <div class="prop-row" style="margin-top:15px;"><button class="btn danger" onclick="borrarSeleccion()" style="justify-content:center;">Eliminar Objeto</button></div>
            </div>
        </div>
    </div>
</div>
<div class="panel-handle handle-right" onclick="togglePanel('right-panel')">‚öôÔ∏è</div>

<div id="modal-reporte" class="modal" onclick="this.style.display='none'"><div class="modal-box" onclick="event.stopPropagation()"><h3>Listado de Materiales</h3><table id="tabla-res" style="width:100%; font-size:0.9rem; border-collapse: collapse; color:#ccc;"></table><br><div style="display:flex; justify-content:space-between; align-items:center;"><button class="btn primary" onclick="exportarCSV()">üìä Exportar CSV</button><button class="btn" onclick="document.getElementById('modal-reporte').style.display='none'">Cerrar</button></div></div></div>
<div id="modal-guardar" class="modal"><div class="modal-box"><h3>Guardar Proyecto</h3><div style="margin-bottom:15px;">Nombre:</div><input type="text" id="input-filename" class="btn-input" value="proyecto_gas" style="width:100%; margin-bottom:15px;"><div style="display:flex; gap:10px; justify-content:flex-end;"><button class="btn" onclick="guardarEnNavegador()">‚ö° Navegador</button><button class="btn primary" onclick="confirmarDescarga()">üíæ Descargar JSON</button><button class="btn" onclick="document.getElementById('modal-guardar').style.display='none'">Cancelar</button></div></div></div>
<div id="modal-insertar" class="modal"><div class="modal-box"><h3>Insertar Elemento en Punto</h3><div class="prop-row"><label>Elemento a integrar:</label><select id="ins-select" class="btn" style="width:100%" onchange="checkInsertType()"></select></div><div class="prop-row row-h" style="margin-top:10px;"><label>Altura Inicial (Z1):</label><input type="text" id="ins-z1" class="btn-input" style="width:100px" placeholder="0.00"></div><div class="prop-row row-h" id="row-ins-z2" style="margin-top:10px;"><label>Altura Final (Z2) (Op):</label><input type="text" id="ins-z2" class="btn-input" style="width:100px" placeholder="0.00"></div><small style="color:#777; font-size:0.75rem; display:block; margin-top:5px;">* Si Z1 es distinto a Z2, se crear√° una tuber√≠a vertical.</small><div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;"><button class="btn primary" onclick="ejecutarInsercion()">Integrar Objeto</button><button class="btn" onclick="cerrarModalInsertar()">Cancelar</button></div></div></div>

<script src="./js/config.js"></script>
<script src="./js/utils.js"></script>

<script>
// --- ESTADO GLOBAL (Definido aqu√≠ para que todos lo vean) ---
window.EPSILON_GRID = 0.001; 
window.layers = [{ id: 'l_gas', name: 'Gas', color: '#FFD700', visible: true }];
window.activeLayerId = 'l_gas';
window.elementos = [];
window.estado = {
    tool: 'select', activeItem: null, mouseIso: {x:0, y:0}, snapped: null, currentZ: 0,
    drawing: false, startPt: null, selID: null, hoverID: null,
    view: { x: 0, y: 0, scale: 1, angle: Math.PI/4 },
    action: null, startAction: {x:0, y:0}, snapDir: null, tempVector: null,
    verticalPendingDir: 0, clipboard: null
};
let historyStack = []; let historyIndex = -1; const MAX_HISTORY = 50;
let insertCoords = { x:0, y:0 };

// --- L√ìGICA DE NEGOCIO ---
window.saveState = function() {
    if (historyIndex < historyStack.length - 1) { historyStack = historyStack.slice(0, historyIndex + 1); }
    const state = JSON.stringify(window.elementos);
    historyStack.push(state);
    if (historyStack.length > MAX_HISTORY) historyStack.shift();
    historyIndex = historyStack.length - 1;
    updateUndoRedoUI();
}

window.undo = function() {
    if (historyIndex > 0) { historyIndex--; restaurarEstado(historyStack[historyIndex]); updateUndoRedoUI(); }
}

window.redo = function() {
    if (historyIndex < historyStack.length - 1) { historyIndex++; restaurarEstado(historyStack[historyIndex]); updateUndoRedoUI(); }
}

function restaurarEstado(jsonState) {
    window.elementos = JSON.parse(jsonState);
    window.estado.selID = null; 
    renderScene(); updatePropsPanel();
    document.getElementById('right-panel').classList.add('closed');
}

function updateUndoRedoUI() {
    document.getElementById('btn-undo').disabled = (historyIndex <= 0);
    document.getElementById('btn-redo').disabled = (historyIndex >= historyStack.length - 1);
}

// LOGICA SOLDADURA
window.moverConConexiones = function(idElemento, dx, dy, dz) {
    const el = window.elementos.find(e => e.id === idElemento); if (!el) return;
    const oldStart = { x: el.x, y: el.y, z: el.z };
    let oldEnd = null;
    if (el.tipo === 'tuberia' || el.tipo === 'cota') { oldEnd = { x: el.x + el.dx, y: el.y + el.dy, z: el.z + el.dz }; }
    el.x += dx; el.y += dy; el.z += dz;
    window.elementos.forEach(vecino => {
        if (vecino.id === idElemento || vecino.visible === false) return;
        if (arePointsEqual({x: vecino.x, y: vecino.y, z: vecino.z}, oldStart)) { vecino.x += dx; vecino.y += dy; vecino.z += dz; } 
        else if (vecino.tipo === 'tuberia' || vecino.tipo === 'cota') {
            const vecEnd = { x: vecino.x + vecino.dx, y: vecino.y + vecino.dy, z: vecino.z + vecino.dz };
            if (arePointsEqual(vecEnd, oldStart)) { vecino.dx += dx; vecino.dy += dy; vecino.dz += dz; }
        }
        if (oldEnd) {
            if (arePointsEqual({x: vecino.x, y: vecino.y, z: vecino.z}, oldEnd)) { vecino.x += dx; vecino.y += dy; vecino.z += dz; }
            else if (vecino.tipo === 'tuberia' || vecino.tipo === 'cota') {
                const vecEnd = { x: vecino.x + vecino.dx, y: vecino.y + vecino.dy, z: vecino.z + vecino.dz };
                if (arePointsEqual(vecEnd, oldEnd)) { vecino.dx += dx; vecino.dy += dy; vecino.dz += dz; }
            }
        }
    });
}

window.cortarTuberia = function(idTuberia, xCorte, yCorte, zCorte) {
    const el = window.elementos.find(e => e.id === idTuberia); if(!el || el.tipo !== 'tuberia') return;
    const finalOriginal = { x: el.x + el.dx, y: el.y + el.dy, z: el.z + el.dz };
    const propsOriginal = JSON.parse(JSON.stringify(el.props));
    el.dx = xCorte - el.x; el.dy = yCorte - el.y; el.dz = zCorte - el.z;
    const dx2 = finalOriginal.x - xCorte; const dy2 = finalOriginal.y - yCorte; const dz2 = finalOriginal.z - zCorte;
    window.addEl({ tipo: 'tuberia', x: xCorte, y: yCorte, z: zCorte, dx: dx2, dy: dy2, dz: dz2, props: propsOriginal, layerId: el.layerId, customColor: el.props.customColor });
}

window.analizarRed = function() {
    const mapNodos = new Map(); const accesorios = [];
    window.elementos.forEach(el => {
        if (el.tipo !== 'tuberia' || el.visible === false) return;
        if (isNaN(el.x) || isNaN(el.dx)) return; 
        const kStart = getKey(el.x, el.y, el.z); const kEnd = getKey(el.x + el.dx, el.y + el.dy, el.z + el.dz);
        const len = Math.hypot(el.dx, el.dy, el.dz); if (len < 0.001) return;
        let width = 2; if (el.props.diametroNominal) width = parseDiameterToScale(el.props.diametroNominal);
        const dir = { x: el.dx/len, y: el.dy/len, z: el.dz/len }; const dirInv = { x: -dir.x, y: -dir.y, z: -dir.z };
        const col = el.props.customColor || el.props.color || '#ccc';
        if (!mapNodos.has(kStart)) mapNodos.set(kStart, []); mapNodos.get(kStart).push({ dir: dir, width: width, color: col });
        if (!mapNodos.has(kEnd)) mapNodos.set(kEnd, []); mapNodos.get(kEnd).push({ dir: dirInv, width: width, color: col });
    });
    mapNodos.forEach((conns, key) => {
        const parts = key.split('_').map(p => parseFloat(p) * window.EPSILON_GRID);
        const x = parts[0], y = parts[1], z = parts[2]; const base = conns[0]; 
        if (conns.length === 2) {
            const c1 = conns[0]; const c2 = conns[1];
            const dot = c1.dir.x * c2.dir.x + c1.dir.y * c2.dir.y + c1.dir.z * c2.dir.z;
            if (dot < -0.99 && Math.abs(c1.width - c2.width) > 0.5) { accesorios.push({ tipo: 'reductor_auto', x, y, z, dirs: [c1.dir, c2.dir], color: base.color, width: Math.max(c1.width, c2.width) }); }
            else if (dot > -0.99 && dot < 0.99) { accesorios.push({ tipo: 'codo_auto', x, y, z, dirs: [c1.dir, c2.dir], color: base.color, width: Math.max(c1.width, c2.width) }); }
        } else if (conns.length === 3) { accesorios.push({ tipo: 'tee_auto', x, y, z, dirs: conns.map(c=>c.dir), color: base.color, width: base.width }); }
        else if (conns.length === 4) { accesorios.push({ tipo: 'cruz_auto', x, y, z, dirs: conns.map(c=>c.dir), color: base.color, width: base.width }); }
    });
    return accesorios;
}

window.addEl = function(data) { 
    if(!data.props.diametroNominal && window.estado.activeItem?.props?.diametroNominal) { data.props.diametroNominal = window.estado.activeItem.props.diametroNominal; }
    window.elementos.push({id:Date.now(), layerId:window.activeLayerId, visible:true, ...data}); 
    saveState(); renderScene(); 
}
window.borrarSeleccion = function() { window.elementos=window.elementos.filter(x=>x.id!==window.estado.selID); window.estado.selID=null; saveState(); updatePropsPanel(); renderScene(); document.getElementById('right-panel').classList.add('closed'); }

// --- HELPERS DE INPUT Y MODALES ---
window.mostrarInputDin√°mico = function(xScreen, yScreen, distActual, vectorData) {
    const box = document.getElementById('dynamic-input-container'); const input = document.getElementById('dynamic-len');
    window.estado.tempVector = { ...vectorData, distOriginal: distActual };
    box.style.left = (xScreen + 15) + 'px'; box.style.top = (yScreen + 15) + 'px'; box.style.display = 'flex';
    const u = window.UNITS[window.CONFIG.unit]; const valDisplay = distActual * u.factor;
    input.value = valDisplay.toFixed(u.precision); input.focus(); input.select();
}
window.confirmarInput = function() {
    const box = document.getElementById('dynamic-input-container'); const input = document.getElementById('dynamic-len');
    const val = parseInputFloat(input.value);
    if (window.estado.tempVector && !isNaN(val) && val > 0) {
        let { dx, dy, dz, distOriginal } = window.estado.tempVector;
        if (distOriginal < 0.001) distOriginal = 1; 
        const valInMeters = parseToMeters(val); const ratio = valInMeters / distOriginal;
        dx *= ratio; dy *= ratio; dz *= ratio;
        const tipo = window.estado.tool === 'cota' ? 'cota' : 'tuberia';
        const props = window.estado.tool === 'cota' ? {} : JSON.parse(JSON.stringify(window.estado.activeItem.props));
        if(window.estado.activeItem?.props?.diametroNominal && !props.diametroNominal) { props.diametroNominal = window.estado.activeItem.props.diametroNominal; }
        window.addEl({ tipo, x: window.estado.inicio.x, y: window.estado.inicio.y, z: window.estado.inicio.z, dx, dy, dz, props });
        if (window.estado.tool !== 'cota') { window.estado.inicio = { x: window.estado.inicio.x + dx, y: window.estado.inicio.y + dy, z: window.estado.inicio.z + dz }; window.estado.drawing = true; } else { window.estado.drawing = false; }
    }
    box.style.display = 'none'; window.estado.tempVector = null; renderScene(); 
}
window.handleCanvasClick = function(e) {
    if(document.getElementById('dynamic-input-container').style.display === 'flex' || document.getElementById('vertical-input-container').style.display === 'flex') return;
    
    // Herramienta CORTAR
    if(window.estado.tool === 'cut' && window.estado.hoverID) {
        const tx = window.estado.snapped ? window.estado.snapped.x : Math.round(window.estado.mouseIso.x*10)/10;
        const ty = window.estado.snapped ? window.estado.snapped.y : Math.round(window.estado.mouseIso.y*10)/10;
        const tz = window.estado.snapped ? window.estado.snapped.z : window.estado.currentZ;
        cortarTuberia(window.estado.hoverID, tx, ty, tz); saveState(); renderScene(); return;
    }
    // Herramienta INSERTAR
    if(window.estado.tool === 'insert') {
        const tx = window.estado.snapped ? window.estado.snapped.x : Math.round(window.estado.mouseIso.x*10)/10;
        const ty = window.estado.snapped ? window.estado.snapped.y : Math.round(window.estado.mouseIso.y*10)/10;
        const tz = window.estado.snapped ? window.estado.snapped.z : window.estado.currentZ;
        abrirModalInsertar(tx, ty, tz); return; 
    }
    // Herramienta SELECT
    if(window.estado.tool === 'select') { 
        window.estado.selID = window.estado.hoverID; 
        if(window.estado.selID) { const el = window.elementos.find(x => x.id === window.estado.selID); if(el) { window.estado.currentZ = el.z; syncZInput(); } }
        updatePropsPanel(); renderEffects();
        const rp = document.getElementById('right-panel'); if(window.estado.selID) { rp.classList.remove('closed'); } else { rp.classList.add('closed'); }
        return; 
    }
    
    // Herramienta DIBUJO (Draw, Cota, etc)
    let tx = window.estado.snapped ? window.estado.snapped.x : Math.round(window.estado.mouseIso.x*10)/10;
    let ty = window.estado.snapped ? window.estado.snapped.y : Math.round(window.estado.mouseIso.y*10)/10;
    let tz = window.estado.snapped ? window.estado.snapped.z : window.estado.currentZ;
    
    if (window.estado.drawing && window.estado.inicio && !window.estado.snapped) {
        const diffX = tx - window.estado.inicio.x; const diffY = ty - window.estado.inicio.y; const diffZ = tz - window.estado.inicio.z; const th = 0.5;
        if (Math.abs(diffY) < th && Math.abs(diffZ) < th) { ty = window.estado.inicio.y; tz = window.estado.inicio.z; } 
        else if (Math.abs(diffX) < th && Math.abs(diffZ) < th) { tx = window.estado.inicio.x; tz = window.estado.inicio.z; } 
        else if (Math.abs(diffX) < th && Math.abs(diffY) < th) { tx = window.estado.inicio.x; ty = window.estado.inicio.y; }
    }

    if(window.estado.tool === 'texto') { const txt = prompt("Texto:", "Etiqueta"); if(txt) { addEl({tipo:'texto', x:tx, y:ty, z:tz, props:{text:txt}}); } return; }
    
    if(window.estado.activeItem?.type === 'tuberia' || window.estado.tool === 'cota') {
        if(!window.estado.drawing) { 
            window.estado.drawing = true; 
            if (window.estado.snapped) { window.estado.currentZ = tz; syncZInput(); }
            window.estado.inicio = {x:tx, y:ty, z:tz}; 
        } else {
            let dx=tx-window.estado.inicio.x, dy=ty-window.estado.inicio.y, dz=tz-window.estado.inicio.z;
            const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
            if(dist > 0.01) { mostrarInputDin√°mico(event.clientX, event.clientY, dist, {dx, dy, dz}); } else { window.estado.drawing = false; }
        }
    } else if (window.estado.activeItem) {
        const props = JSON.parse(JSON.stringify(window.estado.activeItem.props)); 
        if (window.estado.snapDir && (window.estado.activeItem.type === 'valvula' || window.estado.activeItem.type === 'equipo')) { props.dirVector = window.estado.snapDir; delete props.rotacion; }
        addEl({tipo: window.estado.activeItem.type, x:tx, y:ty, z:tz, props, icon: window.estado.activeItem.icon});
    }
    renderInterface();
}

window.abrirModalInsertar = function(x, y, zDefault) {
    insertCoords = { x, y };
    const sel = document.getElementById('ins-select'); sel.innerHTML = '';
    const groupNames = { mat: 'Materiales (Tuber√≠as)', comp: 'Componentes', eq: 'Equipos', inst: 'Instrumentos', perif: 'Perif√©ricos / V√°lvulas', cons: 'Consumibles' };
    Object.keys(window.CATALOGO).forEach(key => {
        const group = document.createElement('optgroup'); group.label = groupNames[key] || key.toUpperCase();
        window.CATALOGO[key].forEach(item => { const opt = document.createElement('option'); opt.value = key + '|' + item.id; opt.innerText = item.name; opt.setAttribute('data-type', item.type); group.appendChild(opt); });
        sel.appendChild(group);
    });
    const u = window.UNITS[window.CONFIG.unit]; document.getElementById('ins-z1').value = (zDefault * u.factor).toFixed(u.precision); document.getElementById('ins-z2').value = (zDefault * u.factor).toFixed(u.precision);
    checkInsertType(); document.getElementById('modal-insertar').style.display = 'flex';
}
window.cerrarModalInsertar = function() { document.getElementById('modal-insertar').style.display = 'none'; setTool('select'); }
window.checkInsertType = function() {
    const sel = document.getElementById('ins-select'); if(!sel.options.length) return;
    const opt = sel.options[sel.selectedIndex]; const type = opt.getAttribute('data-type');
    const rowZ2 = document.getElementById('row-ins-z2'); if(type === 'tuberia') rowZ2.style.display = 'flex'; else rowZ2.style.display = 'none';
}
window.ejecutarInsercion = function() {
    const sel = document.getElementById('ins-select'); const valParts = sel.value.split('|'); const groupKey = valParts[0]; const itemId = valParts[1];
    const itemDef = window.CATALOGO[groupKey].find(x => x.id === itemId); if(!itemDef) return;
    const rawZ1 = parseInputFloat(document.getElementById('ins-z1').value); const rawZ2 = parseInputFloat(document.getElementById('ins-z2').value);
    const u = window.UNITS[window.CONFIG.unit]; const z1Meters = rawZ1 / u.factor; const z2Meters = rawZ2 / u.factor;
    const props = JSON.parse(JSON.stringify(itemDef.props));
    if (itemDef.type === 'tuberia' && Math.abs(z1Meters - z2Meters) > 0.001) { window.addEl({ tipo: 'tuberia', x: insertCoords.x, y: insertCoords.y, z: z1Meters, dx: 0, dy: 0, dz: z2Meters - z1Meters, props: props, layerId: activeLayerId, customColor: itemDef.color }); } 
    else { window.addEl({ tipo: itemDef.type, x: insertCoords.x, y: insertCoords.y, z: z1Meters, dx: 0, dy: 0, dz: 0, props: props, icon: itemDef.icon, layerId: activeLayerId, color: itemDef.color }); }
    document.getElementById('modal-insertar').style.display = 'none'; window.setTool('select'); renderScene();
}
</script>

<script src="./js/renderer.js"></script>

<script src="./js/events.js"></script>

<script>
    // Iniciar todo
    saveState(); 
    renderGrid(); 
    renderGizmo(); 
    initLibrary();
    const rectInit = document.getElementById('lienzo-cad').getBoundingClientRect(); 
    window.estado.view.x = rectInit.width/2; 
    window.estado.view.y = rectInit.height/2; 
    updateTransform();
    
    // Funciones que faltaban globalizar para los botones HTML
    window.setTool = function(t) { 
        window.estado.tool = (t==='cota'||t==='texto'||t==='select'||t==='insert'||t==='cut') ? t : 'draw'; 
        window.estado.drawing=false; window.estado.selID=null; renderEffects(); 
        document.querySelectorAll('.tool-item').forEach(x=>x.classList.remove('active'));
        ['btn-select','btn-cota','btn-texto', 'btn-insert','btn-cut'].forEach(id => { const btn = document.getElementById(id); if(btn) btn.classList.remove('active'); });
        if(document.getElementById('btn-'+t)) { document.getElementById('btn-'+t).classList.add('active'); }
    }
    
    // Auto-guardado check
    setTimeout(function() {
        const backup = localStorage.getItem('backup_cad_gas'); 
        if (backup && confirm("Existe un proyecto guardado en memoria. ¬øDeseas recuperarlo?")) { 
            try { 
                const d = JSON.parse(backup); window.layers = d.layers; window.elementos = d.elementos; saveState(); renderScene(); renderLayersUI(); 
            } catch(e) { console.error(e); } 
        } 
    }, 500);
</script>

</body>
</html>
