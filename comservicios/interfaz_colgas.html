<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I.A. Explorador V4.0 (Fixed) | Entalpia</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #00bcd4;
            --border-color: #444;
            --success-color: #4caf50;
            --warning-color: #ff9800;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        .container { width: 95%; max-width: 1200px; }

        /* HEADER */
        header {
            text-align: center; margin-bottom: 20px;
            border-bottom: 2px solid var(--accent-color); padding-bottom: 15px;
        }
        h1 { color: var(--accent-color); margin: 0; }
        h2 { color: var(--success-color); font-size: 1rem; margin-top: 5px; }

        /* PANELES */
        .panel {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px; margin-bottom: 20px;
        }

        /* BOTON CONEXION */
        .btn-connect {
            background-color: var(--accent-color); color: #000;
            padding: 12px 30px; border: none; border-radius: 4px;
            font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem;
        }
        .btn-connect:hover { filter: brightness(1.1); }

        /* CONTROLES (Inicialmente ocultos) */
        #controlPanel { display: none; } /* Se activa con JS */

        .filters-row {
            display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px;
        }

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { color: var(--accent-color); font-size: 0.8rem; font-weight: bold; }
        
        input, select {
            background: #444; color: #fff; border: 1px solid #666;
            padding: 8px; border-radius: 4px;
        }

        /* BOTONES ACCION */
        .toolbar {
            display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #444; padding-top: 15px;
        }
        .btn {
            padding: 8px 15px; border: 1px solid var(--accent-color);
            background: transparent; color: var(--text-color);
            border-radius: 4px; cursor: pointer;
        }
        .btn:hover { background: var(--accent-color); color: #000; }
        .btn-zip { border-color: var(--success-color); color: var(--success-color); }
        .btn-zip:hover { background: var(--success-color); color: #fff; }

        /* TABLA */
        .table-container { overflow-x: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #333; color: var(--accent-color); position: sticky; top: 0; padding: 10px; text-align: left; }
        td { padding: 8px 10px; border-bottom: 1px solid #444; }
        tr:hover { background: #383838; }

        .loader {
            display: inline-block; width: 15px; height: 15px;
            border: 2px solid #fff; border-top-color: transparent;
            border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #errorLog { color: #ff6b6b; font-size: 0.85rem; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>I.A. Explorador</h1>
        <h2>FILTRO: REALIZADOS SUBIDOS A KAGUA</h2>
    </header>

    <div class="panel">
        <button class="btn-connect" onclick="fetchData()">
            <span id="loader" class="loader" style="display:none"></span>
            üîÑ CONECTAR Y FILTRAR BASE DE DATOS
        </button>
        <div id="statusMsg" style="margin-top:10px; text-align:center; color:#888"></div>
        <div id="errorLog"></div>
    </div>

    <div id="controlPanel" class="panel">
        <div class="filters-row">
            <div class="input-group">
                <label>üìÖ DESDE (Fecha)</label>
                <input type="date" id="dateStart" onchange="applyFilters()">
            </div>
            <div class="input-group">
                <label>üìÖ HASTA</label>
                <input type="date" id="dateEnd" onchange="applyFilters()">
            </div>
            <div class="input-group" style="flex-grow: 1;">
                <label>üîç BUSCADOR INTELIGENTE</label>
                <input type="text" id="searchInput" placeholder="Buscar por Sector, Casa o Nombre..." onkeyup="applyFilters()">
            </div>
        </div>
        
        <div class="toolbar">
            <button class="btn" onclick="exportExcel()">üìä Excel</button>
            <button class="btn btn-zip" onclick="downloadZip()">üì¶ DESCARGAR ZIP (VISIBLES)</button>
        </div>
        <div id="zipStatus" style="text-align: right; font-size: 0.8rem; margin-top: 5px; color: var(--warning-color);"></div>
    </div>

    <div class="panel table-container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Sector</th>
                    <th>Casa</th>
                    <th>Nombre Archivo</th>
                    <th>Link</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="5" style="text-align:center; padding:20px; color:#666">Esperando conexi√≥n...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // URL DE LA HOJA DE C√ÅLCULO (CSV PUBLICADO)
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vThuXIHlfI6bv9jzmTOVSr7Unf-vZLAprGcdXtV_wBu11SEhMfHBWTN4bAK0oYcznAF6A9L9Dh00W_F/pub?output=csv";

    let allData = [];      // Todos los datos cargados v√°lidos
    let filteredData = []; // Datos actualmente filtrados en pantalla

    // --- 1. FUNCI√ìN DE CONEXI√ìN SEGURA ---
    async function fetchData() {
        const btn = document.querySelector('.btn-connect');
        const loader = document.getElementById('loader');
        const msg = document.getElementById('statusMsg');
        const errLog = document.getElementById('errorLog');

        btn.disabled = true;
        loader.style.display = 'inline-block';
        msg.textContent = "Conectando con Google Sheets...";
        errLog.style.display = 'none';

        try {
            const response = await fetch(SHEET_URL);
            if (!response.ok) throw new Error("No se pudo conectar con la hoja de c√°lculo.");
            
            const buffer = await response.arrayBuffer();
            const workbook = XLSX.read(buffer, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // Convertimos a JSON (Matriz de objetos)
            const rawData = XLSX.utils.sheet_to_json(sheet, { defval: "" });

            processData(rawData);

            // √âxito
            loader.style.display = 'none';
            btn.innerHTML = "‚úÖ DATOS ACTUALIZADOS";
            msg.textContent = `Se encontraron ${allData.length} registros v√°lidos (Filtrados por Columna C).`;
            msg.style.color = "var(--success-color)";
            
            // Mostrar interfaz
            document.getElementById('controlPanel').style.display = 'block';

        } catch (e) {
            console.error(e);
            loader.style.display = 'none';
            btn.disabled = false;
            msg.textContent = "Error fatal.";
            errLog.textContent = e.message;
            errLog.style.display = 'block';
        }
    }

    // --- 2. PROCESAMIENTO ROBUSTO (Sin crasheos) ---
    function processData(data) {
        if (!data || data.length === 0) return;

        // Identificar claves basadas en los encabezados del Excel
        const headers = Object.keys(data[0]);
        
        // ASUMIMOS ESTRUCTURA POR ORDEN DE COLUMNAS PARA MAYOR SEGURIDAD
        // 0: Nombre, 1: Link, 2: Estado (Col C), ... buscar fecha
        const keyNombre = headers[0];
        const keyLink = headers[1];
        const keyEstado = headers[2]; // ESTA ES LA COLUMNA C
        
        // Buscar columna de fecha din√°micamente
        const keyFecha = headers.find(h => h.toLowerCase().includes('fecha') || h.toLowerCase().includes('date')) || headers[3];

        allData = [];

        data.forEach((row, index) => {
            try {
                // 1. FILTRO COLUMNA C (Estricto)
                const estadoVal = String(row[keyEstado] || "").trim().toUpperCase();
                if (estadoVal !== "REALIZADOS SUBIDOS A KAGUA") return; // Si no cumple, saltar

                // 2. EXTRACCI√ìN DE DATOS
                const nombre = row[keyNombre] || "Sin Nombre";
                const link = row[keyLink] || "#";
                
                // 3. PARSEO DE FECHA SEGURO (Try-Catch interno para no romper el bucle)
                let fechaObj = null;
                let fechaStr = "";
                try {
                    const rawDate = row[keyFecha];
                    if (rawDate) {
                        if (typeof rawDate === 'number') {
                            // Excel serial date
                            fechaObj = new Date(Math.round((rawDate - 25569) * 86400 * 1000));
                        } else {
                            // String parsing
                            fechaObj = new Date(rawDate);
                        }
                        
                        // Verificar si es fecha v√°lida
                        if (!isNaN(fechaObj.getTime())) {
                            fechaStr = fechaObj.toISOString().split('T')[0];
                        } else {
                            fechaObj = null; // Fecha inv√°lida
                        }
                    }
                } catch (dateErr) {
                    fechaObj = null; // Ignorar errores de fecha
                }

                // 4. Regex para Sector y Casa
                const secMatch = String(nombre).match(/sector\s*(\d+)/i);
                const casaMatch = String(nombre).match(/(?:CS|casa)\s*(\d+)/i);

                allData.push({
                    id: index,
                    nombre: nombre,
                    link: link,
                    sector: secMatch ? secMatch[1] : "-",
                    casa: casaMatch ? casaMatch[1] : "-",
                    fecha: fechaStr,
                    fechaObj: fechaObj // Objeto para filtrar
                });

            } catch (rowErr) {
                console.warn("Fila ignorada por error de formato:", index, rowErr);
            }
        });

        // Ordenar por fecha (las m√°s recientes primero), manejando nulos
        allData.sort((a, b) => (b.fechaObj || 0) - (a.fechaObj || 0));

        // Renderizar inicial
        applyFilters();
    }

    // --- 3. FILTROS (Fecha y Texto) ---
    function applyFilters() {
        const txt = document.getElementById('searchInput').value.toLowerCase();
        const fStart = document.getElementById('dateStart').value ? new Date(document.getElementById('dateStart').value) : null;
        const fEnd = document.getElementById('dateEnd').value ? new Date(document.getElementById('dateEnd').value) : null;
        
        // Ajuste fin del d√≠a para la fecha final
        if (fEnd) fEnd.setHours(23, 59, 59);

        filteredData = allData.filter(item => {
            // A. Filtro Texto
            const matchText = item.nombre.toLowerCase().includes(txt) || 
                              item.sector.includes(txt) || 
                              item.casa.includes(txt);
            
            // B. Filtro Fecha
            let matchDate = true;
            if (fStart || fEnd) {
                if (!item.fechaObj) {
                    matchDate = false; // Ocultar si hay filtro de fecha activo y el item no tiene fecha
                } else {
                    if (fStart && item.fechaObj < fStart) matchDate = false;
                    if (fEnd && item.fechaObj > fEnd) matchDate = false;
                }
            }

            return matchText && matchDate;
        });

        renderTable();
    }

    // --- 4. RENDERIZADO DE TABLA ---
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (filteredData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">No hay datos para mostrar con los filtros actuales.</td></tr>`;
            return;
        }

        // Limitamos visualizaci√≥n a 500 para rendimiento (pero ZIP descarga todo)
        filteredData.slice(0, 500).forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="color:#aaa; font-size:0.85rem">${d.fecha || 'N/A'}</td>
                <td style="color:var(--accent-color); font-weight:bold">${d.sector}</td>
                <td>${d.casa}</td>
                <td>${d.nombre}</td>
                <td>${d.link.startsWith('http') ? `<a href="${d.link}" target="_blank" style="color:var(--success-color)">ABRIR</a>` : ''}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- 5. DESCARGA ZIP (Solo lo filtrado) ---
    async function downloadZip() {
        const files = filteredData.filter(d => d.link && d.link.startsWith('http'));
        
        if (files.length === 0) {
            alert("No hay enlaces v√°lidos en la lista filtrada.");
            return;
        }

        if(!confirm(`Se crear√° un ZIP con ${files.length} archivos.\n\n¬øDesea continuar?`)) return;

        const zip = new JSZip();
        const folder = zip.folder("Archivos_Colgas");
        const statusDiv = document.getElementById('zipStatus');
        
        statusDiv.textContent = "‚è≥ Iniciando descargas... por favor espere.";
        
        let processed = 0;
        
        // Procesamos promesas
        const promises = files.map(async (doc) => {
            try {
                // Convertir link de View a Download si es Google Drive
                let url = doc.link;
                if(url.includes("drive.google.com") && url.includes("/view")) {
                     const id = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                     if(id) url = `https://drive.google.com/uc?export=download&id=${id[1]}`;
                }

                const resp = await fetch(url);
                if(!resp.ok) throw new Error("Err");
                const blob = await resp.blob();
                
                // Nombre archivo
                let name = `${doc.sector}_${doc.casa}_${doc.nombre}`.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                if(blob.type === 'application/pdf') name += ".pdf";
                else name += ".jpg"; // fallback

                folder.file(name, blob);
                
            } catch (err) {
                // Fallback txt
                folder.file(`ERROR_LINK_${doc.nombre.substring(0,10)}.txt`, doc.link);
            }
            processed++;
            statusDiv.textContent = `‚è≥ Procesando ${processed} de ${files.length}...`;
        });

        await Promise.all(promises);

        statusDiv.textContent = "üì¶ Comprimiendo ZIP...";
        zip.generateAsync({type:"blob"}).then(content => {
            saveAs(content, "Respaldo_Colgas.zip");
            statusDiv.textContent = "‚úÖ Descarga completada.";
        });
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(filteredData.map(d => ({
            Fecha: d.fecha, Sector: d.sector, Casa: d.casa, Nombre: d.nombre, Link: d.link
        })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Datos");
        XLSX.writeFile(wb, "Reporte.xlsx");
    }

</script>
</body>
</html>
