<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I.A. Explorador V3.0 | Entalpia</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #00bcd4; /* Azul Cyan */
            --border-color: #444;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --hover-color: #383838;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1200px;
        }

        /* HEADER */
        header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 20px;
        }

        .logo-container img {
            max-height: 80px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        h1 { margin: 0; font-size: 2rem; color: var(--accent-color); text-transform: uppercase; }
        h2 { margin: 10px 0 0 0; font-size: 1.1rem; color: var(--success-color); font-weight: 400; }

        /* PANELES */
        .panel {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        /* CONEXI√ìN */
        .connection-section {
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .btn-connect {
            background-color: var(--accent-color);
            color: #000;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-connect:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 188, 212, 0.4); }

        /* FILTROS DE FECHA */
        .filters-wrapper {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .date-filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-size: 0.8rem;
            color: var(--accent-color);
            font-weight: bold;
        }

        .custom-input {
            background-color: #444;
            color: #fff;
            border: 1px solid #666;
            padding: 8px;
            border-radius: 4px;
        }

        /* INFO BOX */
        .info-box {
            background: rgba(0, 188, 212, 0.1);
            border-left: 4px solid var(--accent-color);
            padding: 10px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: none; /* Se muestra al cargar datos */
        }

        /* TOOLBAR */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .btn {
            background-color: #333;
            color: #fff;
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: 0.3s;
        }

        .btn:hover { background-color: var(--accent-color); color: #000; }
        
        .btn-zip { border-color: var(--success-color); color: var(--success-color); font-weight: bold; }
        .btn-zip:hover { background-color: var(--success-color); color: white; }

        /* TABLA */
        .table-container {
            overflow-x: auto;
            max-height: 500px;
        }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: #333; color: var(--accent-color); position: sticky; top: 0; }
        tr:hover { background-color: var(--hover-color); }

        .status-badge {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success-color);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* LOADER & MODAL */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 16px; height: 16px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .progress-text { margin-top:10px; color: var(--warning-color); font-size: 0.9rem; font-weight: bold; }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo-container">
                <img src="../ImagenesPlataformas/img_logo_colgas.jpg" alt="Logo" onerror="this.style.display='none'">
            </div>
            <h1>I.A. Explorador</h1>
            <h2>Gesti√≥n Documental | Colgas</h2>
        </header>

        <div class="panel connection-section">
            <button class="btn-connect" onclick="fetchGoogleSheet()">
                <div class="loader" id="mainLoader"></div> ‚òÅÔ∏è CONECTAR BASE DE DATOS
            </button>
            <div id="statusMsg" style="margin-top:10px; color:#aaa; font-style:italic;">Sistema listo.</div>
        </div>

        <div id="controlPanel" class="panel" style="display:none; opacity:0.5; pointer-events:none;">
            
            <div class="info-box" id="infoBox">
                üí° <b>Consejo:</b> Usa los filtros de fecha para descargar solo los archivos nuevos. <br>
                Ejemplo: Si tu √∫ltima descarga fue el <i>10/Ene</i>, pon "Desde: 11/Ene".
            </div>

            <div class="filters-wrapper">
                <div class="date-filters">
                    <div class="input-group">
                        <label>üìÖ DESDE (Fecha Creaci√≥n)</label>
                        <input type="date" id="dateStart" class="custom-input" onchange="applyFilters()">
                    </div>
                    <div class="input-group">
                        <label>üìÖ HASTA</label>
                        <input type="date" id="dateEnd" class="custom-input" onchange="applyFilters()">
                    </div>
                </div>

                <div class="input-group" style="flex:1; min-width: 250px;">
                    <label>üîç BUSCAR (Sector, Casa, Nombre...)</label>
                    <input type="text" id="searchInput" class="custom-input" placeholder="Escribe para filtrar..." onkeyup="applyFilters()">
                </div>
            </div>

            <div class="toolbar">
                <button class="btn" onclick="exportToExcel()">üìä Exportar Excel</button>
                <button class="btn btn-zip" onclick="downloadZip()">üì¶ DESCARGAR ZIP (Filtrados)</button>
            </div>
            <div id="zipProgress" class="progress-text"></div>
        </div>

        <div class="panel" id="chartPanel" style="display:none;">
            <div style="height: 250px;">
                <canvas id="myChart"></canvas>
            </div>
        </div>

        <div class="panel table-container">
            <table id="docTable">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Sector</th>
                        <th>Casa</th>
                        <th>Nombre Archivo</th>
                        <th>Estado</th>
                        <th>Link</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6" style="text-align:center; padding:30px; color:#666">Esperando conexi√≥n...</td></tr>
                </tbody>
            </table>
        </div>

        <footer>
            <p style="text-align:center; color:#555; font-size:0.8rem;">Desarrollado por Entalpia &copy; 2025</p>
        </footer>
    </div>

    <script>
        // ==========================================
        //  CONFIGURACI√ìN
        // ==========================================
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vThuXIHlfI6bv9jzmTOVSr7Unf-vZLAprGcdXtV_wBu11SEhMfHBWTN4bAK0oYcznAF6A9L9Dh00W_F/pub?output=csv"; 
        
        let globalData = [];
        let filteredData = [];
        let chartInstance = null;

        // --- 1. CONEXI√ìN Y CARGA ---
        async function fetchGoogleSheet() {
            const btn = document.querySelector('.btn-connect');
            const loader = document.getElementById('mainLoader');
            const msg = document.getElementById('statusMsg');

            btn.disabled = true;
            loader.style.display = 'block';
            msg.textContent = "Descargando y procesando datos...";

            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("Error de red al contactar Google Sheets");
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });

                processData(jsonData);

                // UI Updates
                loader.style.display = 'none';
                btn.innerHTML = "‚úÖ DATOS ACTUALIZADOS";
                msg.textContent = `Se encontraron ${globalData.length} registros v√°lidos.`;
                msg.style.color = "var(--success-color)";
                
                document.getElementById('controlPanel').style.display = 'block';
                document.getElementById('controlPanel').style.opacity = '1';
                document.getElementById('controlPanel').style.pointerEvents = 'auto';
                document.getElementById('infoBox').style.display = 'block';
                document.getElementById('chartPanel').style.display = 'block';

            } catch (error) {
                console.error(error);
                msg.textContent = "Error: " + error.message;
                msg.style.color = "red";
                loader.style.display = 'none';
                btn.disabled = false;
            }
        }

        // --- 2. PROCESAMIENTO DE DATOS ---
        function processData(rawData) {
            if (rawData.length === 0) return;
            const headers = Object.keys(rawData[0]);

            // Detecci√≥n inteligente de columnas
            // Asumimos que la columna C es la de Estado (√≠ndice 2 aprox) o buscamos por nombre
            const colEstado = headers.find(h => h.match(/estado|filtro|carpeta/i)) || headers[2];
            const colFecha = headers.find(h => h.match(/fecha|date|marca/i)); 
            const colLink = headers.find(h => h.match(/link|url|drive/i)) || headers[1];
            const colNombre = headers[0]; // Asumimos primera columna es nombre/descripci√≥n

            globalData = [];

            rawData.forEach(row => {
                const estado = String(row[colEstado] || "").trim().toUpperCase();
                
                // FILTRO PRINCIPAL HARDCODED
                if (estado === "REALIZADOS SUBIDOS A KAGUA") {
                    
                    const rawDate = row[colFecha];
                    const fechaObj = parseDate(rawDate);
                    
                    // Extraer sector y casa con Regex
                    const nombreStr = String(row[colNombre] || "");
                    const secMatch = nombreStr.match(/sector\s*(\d+)/i);
                    const casaMatch = nombreStr.match(/(?:CS|casa)\s*(\d+)/i);

                    globalData.push({
                        nombre: nombreStr,
                        link: row[colLink] || "",
                        estado: estado,
                        sector: secMatch ? secMatch[1] : "N/A",
                        casa: casaMatch ? casaMatch[1] : "N/A",
                        fechaObj: fechaObj, // Objeto Date para filtrar
                        fechaStr: fechaObj ? fechaObj.toISOString().split('T')[0] : "Sin Fecha" // YYYY-MM-DD para mostrar
                    });
                }
            });

            // Ordenar por fecha descendente
            globalData.sort((a, b) => (b.fechaObj || 0) - (a.fechaObj || 0));
            applyFilters();
        }

        // Funci√≥n auxiliar para parsear fechas variadas
        function parseDate(val) {
            if (!val) return null;
            
            // Caso 1: N√∫mero serial de Excel
            if (typeof val === 'number') {
                return new Date(Math.round((val - 25569) * 86400 * 1000));
            }
            
            // Caso 2: Texto
            const str = String(val).trim();
            // Intento DD/MM/YYYY (Formato LATAM)
            if (str.includes('/')) {
                const parts = str.split('/');
                if (parts.length === 3) {
                    // Asumimos DD/MM/YYYY si el primer numero es > 12 o por contexto
                    // Forzamos DD/MM/YYYY
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            
            // Fallback est√°ndar
            const d = new Date(str);
            return isNaN(d) ? null : d;
        }

        // --- 3. FILTROS EN TIEMPO REAL ---
        function applyFilters() {
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const startStr = document.getElementById('dateStart').value;
            const endStr = document.getElementById('dateEnd').value;

            const startDate = startStr ? new Date(startStr) : null;
            const endDate = endStr ? new Date(endStr) : null;
            if (endDate) endDate.setHours(23, 59, 59); // Final del d√≠a

            filteredData = globalData.filter(item => {
                // 1. Filtro Texto
                const matchText = item.nombre.toLowerCase().includes(txt) || 
                                  item.sector.includes(txt) || 
                                  item.casa.includes(txt);

                // 2. Filtro Fecha
                let matchDate = true;
                if (startDate || endDate) {
                    if (!item.fechaObj) {
                        matchDate = false; // Si hay filtro de fecha y el item no tiene fecha, lo ocultamos
                    } else {
                        if (startDate && item.fechaObj < startDate) matchDate = false;
                        if (endDate && item.fechaObj > endDate) matchDate = false;
                    }
                }

                return matchText && matchDate;
            });

            renderTable();
            updateChart();
        }

        // --- 4. RENDERIZADO ---
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">No hay documentos que coincidan con los filtros.</td></tr>`;
                return;
            }

            // Limitamos a mostrar 100 filas para no congelar el navegador si son muchos
            // (Pero el ZIP descargar√° TODOS los filtrados)
            const showLimit = filteredData.slice(0, 100);

            showLimit.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${d.fechaStr}</td>
                    <td>${d.sector}</td>
                    <td>${d.casa}</td>
                    <td>${d.nombre}</td>
                    <td><span class="status-badge">${d.estado}</span></td>
                    <td>${d.link ? `<a href="${d.link}" target="_blank" style="color:var(--accent-color)">Ver</a>` : '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            if (filteredData.length > 100) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="6" style="text-align:center; color:#888;">... y ${filteredData.length - 100} registros m√°s (visibles al exportar/descargar) ...</td>`;
                tbody.appendChild(tr);
            }
        }

        function updateChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            
            // Agrupar por Sector
            const counts = {};
            filteredData.forEach(d => {
                const key = "Sector " + d.sector;
                counts[key] = (counts[key] || 0) + 1;
            });

            const labels = Object.keys(counts).sort();
            const data = labels.map(l => counts[l]);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Documentos por Sector',
                        data: data,
                        backgroundColor: 'rgba(0, 188, 212, 0.6)',
                        borderColor: '#00bcd4',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#444' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { labels: { color: '#ccc' } } }
                }
            });
        }

        // --- 5. L√ìGICA DE DESCARGA ZIP (El punto cr√≠tico) ---
        async function downloadZip() {
            const validFiles = filteredData.filter(d => d.link && d.link.startsWith('http'));
            
            if (validFiles.length === 0) {
                alert("No hay documentos con enlaces v√°lidos en la selecci√≥n actual.");
                return;
            }
            
            if (!confirm(`Vas a descargar un ZIP con ${validFiles.length} documentos filtrados.\n\nEsto puede tardar dependiendo de tu internet.\n¬øContinuar?`)) return;

            const zip = new JSZip();
            const folder = zip.folder("Documentos_Colgas");
            const progressDiv = document.getElementById('zipProgress');
            let processed = 0;
            let errors = 0;

            progressDiv.textContent = "‚è≥ Iniciando descarga...";

            // Procesar en lotes peque√±os para no saturar
            for (let i = 0; i < validFiles.length; i++) {
                const doc = validFiles[i];
                progressDiv.textContent = `‚è≥ Procesando archivo ${i+1} de ${validFiles.length}...`;
                
                try {
                    // Intento de convertir enlace View a Download Directo
                    // Esto ayuda a evitar la p√°gina HTML de Google Drive y obtener el binario
                    let downloadUrl = doc.link;
                    if (downloadUrl.includes("drive.google.com") && downloadUrl.includes("/view")) {
                        const idMatch = downloadUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
                        if (idMatch) {
                            downloadUrl = `https://drive.google.com/uc?export=download&id=${idMatch[1]}`;
                        }
                    }

                    // FETCH
                    // Nota: Si Google Drive bloquea por CORS, esto fallar√° y ir√° al catch.
                    const response = await fetch(downloadUrl);
                    if (!response.ok) throw new Error("Bloqueo o error de red");
                    const blob = await response.blob();

                    // Nombre limpio
                    let fileName = `${doc.sector}_${doc.casa}_${doc.nombre}`.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    // Extensi√≥n
                    if (blob.type === "application/pdf") fileName += ".pdf";
                    else if (blob.type.includes("image")) fileName += ".jpg";
                    else fileName += ".pdf"; // default

                    folder.file(fileName, blob);

                } catch (e) {
                    console.warn("Fallo descarga directa: " + doc.nombre);
                    // Si falla (muy probable por CORS de Google), creamos un TXT con el link
                    // para que el usuario no pierda el archivo.
                    folder.file(`MANUAL_${doc.nombre.substring(0,20)}.txt`, `Este archivo no pudo descargarse autom√°ticamente por seguridad de Google.\nDesc√°rgalo aqu√≠: ${doc.link}`);
                    errors++;
                }
                processed++;
            }

            progressDiv.textContent = "üì¶ Comprimiendo ZIP...";
            
            zip.generateAsync({ type: "blob" }).then(function(content) {
                saveAs(content, `Respaldo_Colgas_${new Date().toISOString().slice(0,10)}.zip`);
                progressDiv.textContent = `‚úÖ Listo. ${processed - errors} descargados, ${errors} enlaces manuales (ver .txt en ZIP).`;
                
                if (errors > 0) {
                    alert(`Se gener√≥ el ZIP.\n\nNota: ${errors} archivos no permitieron descarga directa (Google Drive bloque√≥ el acceso automatizado). En su lugar, encontrar√°s archivos de texto con el enlace directo dentro del ZIP.`);
                }
            });
        }

        // --- EXPORTAR EXCEL ---
        function exportToExcel() {
            if (filteredData.length === 0) return alert("Sin datos para exportar");
            const ws = XLSX.utils.json_to_sheet(filteredData.map(d => ({
                Fecha: d.fechaStr, Sector: d.sector, Casa: d.casa, Nombre: d.nombre, Estado: d.estado, Link: d.link
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte");
            XLSX.writeFile(wb, "Reporte_Colgas.xlsx");
        }

    </script>
</body>
</html>
